#+title: Scripts

* Clone the english language lab

#+BEGIN_SRC sh :tangle clone-english-lab.sh

  lab_name=molecular-absorption-spectroscopy-responsive-lab
  enlab_url=https://github.com/virtual-labs/${lab_name}.git
  git clone ${enlab_url}

#+END_SRC

* Copy the lab for translation

Make a new copy before translation (if it does not exist).  If a
directory already exists for the target language, then it's either a
rerun, or you are trying to add the translated files to an existing
repo which probably has a remote.  In which case you should push the
latest changes after validation.

#+BEGIN_SRC sh :tangle copy-lab.sh

  lab_name=molecular-absorption-spectroscopy-responsive-lab
  enlab_path=enlab/$lab_name
  lab_copy_path=hindilab
  mkdir -p ${lab_copy_path}
  cp -rf ${enlab_path} ${lab_copy_path}

#+END_SRC

* Extract Text

The IFS variable needs to modified temporarily because we have files
with whitespaces in their names.

Refer to this article for more details:
https://www.cyberciti.biz/tips/handling-filenames-with-spaces-in-bash.html


#+BEGIN_SRC sh :tangle extract-text.sh

  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")

  lab_name=molecular-absorption-spectroscopy-responsive-lab
  target_lab_path=hindilab/${lab_name}/src/lab
  for html_file in $(find $target_lab_path -maxdepth 1 -type f -name "*.html")
  do
    echo $html_file
    node extract.js $html_file
  done

  IFS=$OLDIFS
#+END_SRC

* Translate

#+BEGIN_SRC sh :tangle translate.sh

  export GOOGLE_APPLICATION_CREDENTIALS="Lab Translation-88029d170826.json"

  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")

  lab_name=molecular-absorption-spectroscopy-responsive-lab
  target_lab_path=hindilab/${lab_name}/src/lab
  for json_file in $(find $target_lab_path -maxdepth 1 -type f -name "*.json")
  do
    echo $json_file
    node translate-json.js $json_file
  done

  IFS=$OLDIFS

#+END_SRC

* Rebuild HTML

#+BEGIN_SRC sh :tangle rebuild.sh

  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")

  lab_name=molecular-absorption-spectroscopy-responsive-lab
  target_lab_path=hindilab/${lab_name}/src/lab
  for html_file in $(find $target_lab_path -maxdepth 1 -type f -name "*.html")
  do
    echo $html_file
    node rebuildhtml.js $html_file
  done

  IFS=$OLDIFS

#+END_SRC

* Putting it all together

#+BEGIN_SRC sh :tangle run.sh


  cmd=$1
  lab_name=$2
  src=$3
  dest=$4

  function clone_remote_lab {
    echo "[[ clone ]] > copy > extract > translate > rebuild"
    echo "cloning into ${lab_name} and placing in ${src}"
    mkdir -p $src;
    cd $src; git clone https://github.com/virtual-labs/${lab_name}.git
    echo "cloning complete."
  }

  function copy_lab {
    echo "clone > [[ copy ]] > extract > translate > rebuild"
    echo "copying lab from $src to $dest"
    cp -rf $src/ $dest/
    echo "copying complete."
  }

  function extract_text {
    echo "clone > copy > [[ extract ]] > translate > rebuild"
    echo "extracting text from all the html files in $dest"
    
    OLDIFS=$IFS
    IFS=$(echo -en "\n\b")
    
    target_lab_path=${dest}/${lab_name}/src/lab
    for html_file in $(find $target_lab_path -maxdepth 2 -type f -name "*.html")
    do
      echo $html_file
      node extract.js $html_file
    done

    IFS=$OLDIFS    

    echo "extraction complete"
  }

  function translate_text {
    echo "clone > copy > extract > [[ translate ]] > rebuild"
    echo "Translating text from all json files."
    
    export GOOGLE_APPLICATION_CREDENTIALS="Lab Translation-88029d170826.json"

    OLDIFS=$IFS
    IFS=$(echo -en "\n\b")

    target_lab_path=${dest}/${lab_name}/src/lab
    for json_file in $(find $target_lab_path -maxdepth 2 -type f -name "*.json")
    do
      echo $json_file
      node translate-json.js $json_file
    done

    IFS=$OLDIFS

    echo "translation complete"
  }

  function rebuild_lab {
    echo "clone > copy > extract > translate > [[ rebuild ]]"
    echo "Rebuilding all html file"
    

    OLDIFS=$IFS
    IFS=$(echo -en "\n\b")
    target_lab_path=${dest}/${lab_name}/src/lab
    for html_file in $(find $target_lab_path -maxdepth 2 -type f -name "*.html")
    do
      echo $html_file
      node rebuildhtml.js $html_file
    done
    IFS=$OLDIFS

    echo "lab translation is complete.  Now validate it."
  }

  case $cmd in
    clone)
	clone_remote_lab
	;;
    copy)
	copy_lab
	;;
    extract)
	extract_text
	;;
    translate)
	translate_text
	;;
    rebuild)
	rebuild_lab
	;;
    all)
        clone_remote_lab
	copy_lab
	extract_text
	translate_text
	rebuild_lab
	;;
    again)
	copy_lab
	extract_text
	translate_text
	rebuild_lab
	;;
  esac

#+END_SRC
